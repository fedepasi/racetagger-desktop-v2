<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Racetagger Desktop</title>
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/sidebar.css">
  <link rel="stylesheet" href="css/auth.css">
  <link rel="stylesheet" href="css/desktop-theme.css">
  
  <!-- Enhanced UI Components -->
  <link rel="stylesheet" href="css/smart-presets.css">
  <link rel="stylesheet" href="css/enhanced-progress.css">
  <link rel="stylesheet" href="css/processing-status.css">
  <link rel="stylesheet" href="css/enhanced-file-browser.css">
  
  <!-- Delight System -->
  <link rel="stylesheet" href="css/delight-system.css">
  
  <!-- Admin Features -->
  <link rel="stylesheet" href="css/admin-features.css">

  <!-- Home Page User-Friendly Styles -->
  <link rel="stylesheet" href="css/home-user.css">
  <link rel="stylesheet" href="css/participants.css">

  <!-- Settings Page -->
  <link rel="stylesheet" href="css/settings.css">

  <!-- Feedback Modal -->
  <link rel="stylesheet" href="css/feedback-modal.css">

  <!-- Router Page Container Styles -->
  <style>
    .page-container {
      display: none;
    }
    .page-container.active {
      display: block;
    }
    .page-container.page-loading {
      opacity: 0.6;
      pointer-events: none;
    }
    .error-page {
      padding: 2rem;
      text-align: center;
    }
    .error-page h2 {
      color: var(--color-danger, #e74c3c);
      margin-bottom: 1rem;
    }
    .error-page button {
      margin-top: 1rem;
      padding: 0.5rem 1.5rem;
      background: var(--color-primary, #2196F3);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- Window Chrome (macOS style) -->
  <div class="window-chrome">
    <div class="window-controls">
      <div class="window-control window-close"></div>
      <div class="window-control window-minimize"></div>
      <div class="window-control window-maximize"></div>
      <div class="window-title">Racetagger Desktop</div>
    </div>
    <div class="window-actions">
      <button class="window-action-button">
        <span>Support</span>
      </button>
    </div>
  </div>
  <!-- User Menu -->
  <div id="user-bar" class="user-bar" style="display: none;">
    <div id="logo" class="app-logo">
      <img src="racetagger-logo.png" alt="RaceTagger" class="logo-icon">
      <span class="logo-text">RaceTagger</span>
    </div>
    <div id="token-balance-widget" class="token-balance-widget">
      <div class="token-info">
        <span class="token-icon">ü™ô</span>
        <span class="token-amount" id="token-balance">0</span>
        <span class="token-label">images remaining</span>
        <button id="refresh-tokens-btn" class="refresh-btn" title="Refresh token balance">‚ü≥</button>
      </div>
      <button id="buy-tokens-btn" class="btn btn-outline btn-sm">Buy more analyses</button>
    </div>
  </div>

  <!-- Auth Container -->
  <div id="auth-container" class="auth-container" style="display: none;">
    <div class="auth-modal">
      <div class="auth-layout">
        <!-- Left column with app information -->
        <div class="auth-sidebar">
          <div class="auth-sidebar-content">
            <h1>Racetagger Desktop</h1>
            <p class="auth-tagline">Automatic race image analysis</p>

            <div class="auth-features">
              <div class="auth-feature-item">
                <span class="auth-feature-icon">üîç</span>
                <p>AI-powered race number recognition</p>
              </div>
              <div class="auth-feature-item">
                <span class="auth-feature-icon">üìä</span>
                <p>Single image or batch folder analysis</p>
              </div>
              <div class="auth-feature-item">
                <span class="auth-feature-icon">üìù</span>
                <p>CSV integration for metadata</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Right column with login/register forms -->
        <div class="auth-content">
          <div class="auth-tabs">
            <button id="login-tab" class="auth-tab active">Login</button>
            <button id="register-tab" class="auth-tab">Sign Up</button>
          </div>

          <div id="login-panel" class="auth-panel">
            <form id="login-form">
              <div class="form-group">
                <label for="login-email">Email</label>
                <input type="email" id="login-email" required autocomplete="email">
              </div>
              <div class="form-group">
                <label for="login-password">Password</label>
                <input type="password" id="login-password" required autocomplete="current-password">
              </div>
              <div class="form-actions">
                <button type="submit" class="btn primary">Sign In</button>
              </div>
              <div id="login-error" class="error-message" style="display: none;"></div>
            </form>
          </div>

          <div id="register-panel" class="auth-panel" style="display: none;">
            <form id="register-form">
              <div class="form-group">
                <label for="register-email">Email address</label>
                <input type="email" id="register-email" required autocomplete="email" placeholder="you@example.com">
              </div>
              <div class="form-group">
                <label for="register-password">Password</label>
                <input type="password" id="register-password" required minlength="8" autocomplete="new-password" placeholder="Create a strong password">
                <div id="password-strength" class="password-strength" style="display: none;">
                  <div class="strength-bar">
                    <div id="strength-bar-fill" class="strength-bar-fill"></div>
                  </div>
                  <div class="strength-label">
                    <span id="strength-text">Password strength: </span>
                  </div>
                </div>
              </div>
              <div class="form-group">
                <label for="register-confirm-password">Confirm password</label>
                <input type="password" id="register-confirm-password" required minlength="8" autocomplete="new-password" placeholder="Confirm your password">
              </div>

              <!-- Referral Code (optional) -->
              <div class="form-group referral-code-group">
                <label for="register-referral-code">Referral code <span class="optional-label">(optional)</span></label>
                <input type="text" id="register-referral-code" autocomplete="off" placeholder="Enter referral code if you have one">
                <p class="field-hint">Received an invite? Enter the code to reward your referrer.</p>
              </div>

              <!-- Password Requirements -->
              <div class="password-requirements">
                <p class="requirements-title">Password requirements:</p>
                <ul class="requirements-list">
                  <li id="req-length" class="requirement-item">
                    <span class="requirement-icon">‚óã</span>
                    <span>At least 8 characters</span>
                  </li>
                  <li id="req-uppercase" class="requirement-item">
                    <span class="requirement-icon">‚óã</span>
                    <span>One uppercase letter</span>
                  </li>
                  <li id="req-lowercase" class="requirement-item">
                    <span class="requirement-icon">‚óã</span>
                    <span>One lowercase letter</span>
                  </li>
                  <li id="req-number" class="requirement-item">
                    <span class="requirement-icon">‚óã</span>
                    <span>One number</span>
                  </li>
                </ul>
              </div>

              <div class="form-actions">
                <button type="submit" class="btn primary">Create Account</button>
                <button type="button" id="back-to-login" class="btn secondary">Back to Login</button>
              </div>
              <div id="register-error" class="error-message" style="display: none;"></div>
              <div id="register-success" class="success-message" style="display: none;"></div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main App Container -->
  <div id="main-app-container" class="app-container hidden">
    <!-- Sidebar -->
    <aside class="sidebar">
      <nav class="sidebar-nav">
        <a href="#" class="nav-item active" data-section="home">
          <div class="nav-icon">üè†</div>
          <div class="nav-text">Home</div>
        </a>
        <a href="#" class="nav-item" data-section="analysis">
          <div class="nav-icon">üîç</div>
          <div class="nav-text">Analysis</div>
        </a>
        <a href="#" class="nav-item" data-section="participants">
          <div class="nav-icon">üë•</div>
          <div class="nav-text">Participants</div>
        </a>
        <!-- Export Destinations - Hidden for now
        <a href="#" class="nav-item" data-section="destinations">
          <div class="nav-icon">üì§</div>
          <div class="nav-text">Export Destinations</div>
        </a>
        -->

        <!-- Divider before Settings -->
        <div class="nav-separator"></div>

        <!-- Settings -->
        <a href="#" class="nav-item" data-section="settings">
          <div class="nav-icon">‚öôÔ∏è</div>
          <div class="nav-text">Settings</div>
        </a>

        <!-- Logout -->
        <a href="#" class="nav-item nav-item-logout" id="sidebar-logout-btn">
          <div class="nav-icon">üö™</div>
          <div class="nav-text">Logout</div>
        </a>
      </nav>
      <div class="sidebar-footer">
        <div id="sidebar-user-avatar" class="user-avatar">?</div>
        <div class="user-info">
          <div id="sidebar-user-email" class="user-email">Not logged in</div>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Dynamic Page Container (for router-loaded pages) -->
      <div id="page-content" class="page-container"></div>

      <footer class="app-footer">
      <p>
        <strong>RaceTagger Desktop</strong> <span id="app-version">v1.0.8</span><br>
        <small>Developed by Federico Pasinetti</small>
      </p>
    </footer>

    </main>
  </div>

  <!-- Sortable Table Library - lightweight table sorting with no dependencies (local copy for offline support) -->
  <script src="js/vendor/sortable.min.js"></script>

  <!-- Navigo Router -->
  <script src="js/vendor/navigo.min.js"></script>
  <script src="js/router.js"></script>

  <!-- Last Analysis Settings Manager -->
  <script src="js/last-analysis-settings.js"></script>

  <script src="js/streaming-view.js"></script>
  <script src="js/gallery-zoom.js"></script>
  <script src="js/log-visualizer.js"></script>
  <script src="js/renderer.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/desktop-ui.js"></script>
  <script src="js/settings.js"></script>
  <script src="js/export-destinations.js"></script>

  <!-- Enhanced UI Components -->
  <script src="js/smart-presets.js"></script>
  <script src="js/enhanced-progress.js"></script>
  <script src="js/enhanced-processing.js"></script>
  <script>
    // Mobile Menu Handler
    document.addEventListener('DOMContentLoaded', () => {
      const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
      const sidebar = document.getElementById('sidebar');
      const sidebarOverlay = document.getElementById('sidebar-overlay');
      
      if (mobileMenuToggle && sidebar && sidebarOverlay) {
        // Toggle sidebar on button click
        mobileMenuToggle.addEventListener('click', () => {
          sidebar.classList.toggle('mobile-active');
          sidebarOverlay.classList.toggle('active');
        });
        
        // Close sidebar on overlay click
        sidebarOverlay.addEventListener('click', () => {
          sidebar.classList.remove('mobile-active');
          sidebarOverlay.classList.remove('active');
        });
        
        // Close sidebar on escape key
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && sidebar.classList.contains('mobile-active')) {
            sidebar.classList.remove('mobile-active');
            sidebarOverlay.classList.remove('active');
          }
        });
      }
    });
  </script>
  <!-- Participants Management (must load before enhanced-file-browser) -->
  <script src="js/participants-manager.js"></script>
  <script src="js/preset-face-manager.js"></script>
  <script src="js/driver-face-manager.js"></script>

  <script src="js/enhanced-file-browser.js"></script>
  <script src="js/enhanced-ui-coordinator.js"></script>

  <!-- Delight System -->
  <script src="js/delight-system.js"></script>
  <script src="js/delight-integration.js"></script>

  <!-- Admin Features -->
  <script src="js/admin-features.js"></script>

  <!-- Visual Tagging -->
  <script src="js/visual-tagging-manager.js"></script>

  <!-- Home Page Logic -->
  <script src="js/home.js"></script>

  <!-- Unified Support Modal (feedback + diagnostics) -->
  <script src="js/feedback-modal.js"></script>

  <!-- Face Recognition -->
  <script src="js/vendor/face-api.min.js"></script>
  <script src="js/face-detector.js"></script>
  <script src="js/face-recognition-ui.js"></script>

  <!-- Image Modal -->
  <div id="image-modal" class="image-modal">
    <div class="image-modal-content">
      <div class="modal-header">
        <h3 id="modal-image-title">View Image</h3>
        <button class="modal-close" id="modal-close-btn">&times;</button>
      </div>
      <div class="modal-body">
        <img id="modal-image" class="modal-image" src="" alt="Enlarged image">
      </div>
    </div>
  </div>

  <!-- Mobile Sidebar Overlay -->
  <div class="sidebar-overlay" id="sidebar-overlay"></div>

  <!-- Token Info Modal -->
  <div id="token-info-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content token-info-modal">
      <div class="modal-header">
        <h2>Get More Analyses</h2>
        <button type="button" id="close-token-info-modal" class="btn btn-secondary btn-sm">√ó</button>
      </div>

      <div class="modal-body">
        <!-- Hero Message -->
        <div class="pricing-hero">
          <div class="hero-icon">üéÅ</div>
          <h3>Special Launch Offer</h3>
          <p class="hero-subtitle">
            <strong>Up to 42% OFF</strong>
          </p>
        </div>

        <!-- Benefits Grid -->
        <div class="benefits-grid">
          <div class="benefit-item">
            <span class="benefit-icon">‚úì</span>
            <span>Tokens Never Expire</span>
          </div>
          <div class="benefit-item">
            <span class="benefit-icon">‚úì</span>
            <span>No Monthly Fees</span>
          </div>
          <div class="benefit-item">
            <span class="benefit-icon">‚úì</span>
            <span>Founder's Price Lock</span>
          </div>
          <div class="benefit-item">
            <span class="benefit-icon">‚úì</span>
            <span>Instant Delivery</span>
          </div>
        </div>

        <!-- CTA Section -->
        <div class="pricing-cta">
          <p class="cta-text">
            View our flexible token packs and choose the one that fits your needs.
          </p>
          <button type="button" id="open-pricing-page" class="btn btn-primary btn-cta btn-large">
            View Pricing & Buy Tokens ‚Üí
          </button>
          <p class="cta-note">
            Opens in your browser ‚Ä¢ Secure Stripe checkout ‚Ä¢ Instant activation
          </p>
        </div>

        <!-- Early Bird Urgency -->
        <div class="urgency-banner">
          <span class="urgency-icon">‚è∞</span>
          <span>Limited Until December 31, 2025</span>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" id="cancel-token-info" class="btn btn-secondary">Close</button>
      </div>
    </div>
  </div>

  <!-- No Preset Warning Modal -->
  <div id="no-preset-warning-modal" class="modal">
    <div class="modal-content no-preset-modal">
      <div class="modal-header">
        <h2>Improve Your Results</h2>
        <button class="modal-close" onclick="closeNoPresetWarning()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="no-preset-hero">
          <div class="hero-icon">üí°</div>
          <p class="hero-text">
            You're about to start recognition <strong>without a participant preset</strong>.
          </p>
        </div>

        <p class="no-preset-intro">
          While RaceTagger will still detect race numbers, using a participant preset can
          <strong>significantly improve accuracy</strong> by:
        </p>

        <ul class="benefits-list">
          <li><span class="benefit-check">‚úì</span> Validating detected numbers against known participants</li>
          <li><span class="benefit-check">‚úì</span> Auto-filling driver names, teams, and metadata</li>
          <li><span class="benefit-check">‚úì</span> Reducing false positives and corrections needed</li>
        </ul>

        <a href="#" onclick="openPresetGuide(); return false;" class="guide-link">
          üìñ Learn how to create a participant preset
        </a>

        <label class="dont-show-checkbox">
          <input type="checkbox" id="no-preset-dont-show-again">
          <span>Don't show this again</span>
        </label>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeNoPresetWarning()">Cancel</button>
        <button class="btn btn-primary" onclick="continueWithoutPreset()">
          Continue Anyway
        </button>
      </div>
    </div>
  </div>

  <!-- Adobe DNG Converter Required Modal -->
  <div id="adobe-dng-modal" class="modal" style="display: none;">
    <div class="modal-content adobe-dng-modal-content">
      <div class="modal-header adobe-dng-modal-header">
        <h2><i class="fas fa-exclamation-triangle"></i> Adobe DNG Converter Required</h2>
      </div>
      <div class="modal-body adobe-dng-modal-body">
        <p>
          <strong>RAW files detected:</strong> This folder contains RAW image files that require 
          Adobe DNG Converter for processing.
        </p>
        <p>
          Adobe DNG Converter is not currently installed on your system. 
          Please download and install it to process RAW images.
        </p>
        
        <div class="download-section">
          <p><strong>Download Adobe DNG Converter:</strong></p>
          <a href="https://helpx.adobe.com/camera-raw/using/adobe-dng-converter.html" 
             target="_blank" 
             class="download-link">
            <i class="fas fa-download"></i> Official Adobe Download Page
          </a>
          <p class="download-note">
            <i class="fas fa-info-circle"></i> 
            The download page will automatically detect your operating system.
          </p>
        </div>

        <div class="warning-section">
          <p><strong>Note:</strong> Without Adobe DNG Converter, RAW files cannot be processed. 
          Only JPEG files in the selected folder will be analyzed.</p>
        </div>
      </div>
      <div class="modal-footer adobe-dng-modal-footer">
        <button class="btn btn-secondary" onclick="closeAdobeDngModal()">
          <i class="fas fa-times"></i> Cancel Selection
        </button>
        <button class="btn btn-warning" onclick="continueWithoutDng()">
          <i class="fas fa-forward"></i> Continue Without RAW Support
        </button>
      </div>
    </div>
  </div>

  <!-- Model Download Modal (shown at startup if models need downloading) -->
  <div id="model-download-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content modal-download">
      <div class="download-header">
        <span class="download-icon">&#x2B07;&#xFE0F;</span>
        <h2>Downloading Resources</h2>
      </div>
      <div class="download-body">
        <p class="download-message">
          Downloading required resources...
        </p>
        <p class="download-note">
          This only happens once (or after updates).
        </p>
        <div class="download-progress-container">
          <div class="download-progress-bar">
            <div id="download-progress-fill" class="download-progress-fill"></div>
          </div>
          <span id="download-percent" class="download-percent">0%</span>
        </div>
        <div id="download-stats" class="download-stats">
          <span id="download-current">0 MB</span> / <span id="download-total">0 MB</span>
        </div>
        <p id="download-fun-fact" class="download-fun-fact">
          &#x1F3CE;&#xFE0F; "Like downloading the latest telemetry data..."
        </p>
      </div>
    </div>
  </div>

  <!-- Support FAB (Floating Action Button) + First-time tooltip -->
  <div class="feedback-fab-wrapper" id="feedback-fab-wrapper">
    <div class="feedback-fab-tooltip" id="feedback-fab-tooltip">
      <span class="feedback-fab-tooltip-text">Report a bug, request a feature, or share your feedback ‚Äî we're listening!</span>
      <button class="feedback-fab-tooltip-close" id="feedback-fab-tooltip-close" aria-label="Close">&times;</button>
    </div>
    <button class="feedback-fab" id="feedback-fab" onclick="openFeedbackModal()" title="Support">
      <svg class="feedback-fab-icon" viewBox="-1 -2 26 27" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M3 11h1a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2H3a1 1 0 0 1-1-1v-5a1 1 0 0 1 1-1Z"/>
        <path d="M21 11h-1a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1a1 1 0 0 0 1-1v-5a1 1 0 0 0-1-1Z"/>
        <path d="M2 11V9a10 10 0 0 1 20 0v2"/>
        <path d="M18 18v1a2 2 0 0 1-2 2h-2"/>
      </svg>
    </button>
  </div>

</body>
</html>
