{
  "permissions": {
    "allow": [
      "Bash(./vendor/win32/exiftool.exe:*)",
      "Bash(unzip:*)",
      "Bash(./exiftool.exe exiftool.pl)",
      "Bash(./perl.exe exiftool.pl -ver)",
      "Bash(Select-String -Pattern \"RawPreviewExtractor|ExifTool extraction|preview extraction|Native extraction|extraction successful|extraction failed\")",
      "Bash(powershell:*)",
      "Bash(npm run build:*)",
      "Bash(export APPLE_APP_SPECIFIC_PASSWORD=ewng-ijfy-xvne-cytg)",
      "Bash(npm run rebuild:sharp:*)",
      "Bash(cat:*)",
      "Bash(icns2png:*)",
      "Bash(sips:*)",
      "Bash(npx asar list:*)",
      "Bash(git add:*)",
      "Bash(git commit:*)",
      "Bash(git push:*)",
      "Bash(git tag:*)",
      "Bash(ls:*)",
      "Read(//Users/federicopasinetti/Documents/WebProjects/Racetagger_V3/**)",
      "Bash(find:*)",
      "Bash(node:*)",
      "Bash(npm run compile:*)",
      "Bash(npx tsc:*)",
      "Read(///**)",
      "Bash(npx supabase functions logs:*)",
      "Read(//Users/federicopasinetti/.racetagger-temp/**)",
      "Read(//Users/federicopasinetti/**)",
      "Bash(xargs ls:*)",
      "Bash(curl:*)",
      "Bash(mkdir:*)",
      "Bash(mv:*)",
      "Bash(tree:*)",
      "Bash(npx supabase functions deploy:*)",
      "Bash(tee:*)",
      "Bash(for:*)",
      "Bash(do echo \"=== $file ===\")",
      "Bash(done)",
      "Bash(xcrun notarytool submit:*)",
      "Bash(export APPLE_TEAM_ID=\"MNPJV89MMU\")",
      "Bash(export APPLE_ID=\"info@federicopasinetti.it\")",
      "Bash(__NEW_LINE__ echo \"Credentials set:\")",
      "Bash(echo:*)",
      "Bash(echo \"Apple ID: $APPLE_ID\")",
      "Bash(openssl x509:*)",
      "Bash(xcrun notarytool info:*)",
      "Bash(pkill:*)",
      "Bash(xcrun notarytool log:*)",
      "Bash(git log:*)",
      "Bash(security find-identity -v -p codesigning)",
      "Bash(if [ -z \"$APPLE_ID\" ])",
      "Bash([ -z \"$APPLE_APP_SPECIFIC_PASSWORD\" ])",
      "Bash([ -z \"$APPLE_TEAM_ID\" ])",
      "Bash(then)",
      "Bash(else)",
      "Bash(fi)",
      "Read(//private/tmp/**)",
      "Bash(mount)",
      "Bash(npx electron-builder --mac --arm64)",
      "Bash(gh release create v1.0.10 )",
      "Bash(release/RaceTagger-1.0.10-arm64.dmg )",
      "Bash(release/RaceTagger-1.0.10-arm64-mac.zip)",
      "Bash(npx supabase db dump:*)",
      "Bash(npm run dev:*)",
      "Bash(sysctl:*)",
      "Bash(awk:*)",
      "Bash(ps:*)",
      "Bash(then echo \"❌ Credenziali Apple mancanti\")",
      "Bash(else echo \"✅ Credenziali Apple configurate\")",
      "Bash(npm run build:mac:x64:*)",
      "Bash(npm run build:mac:universal:*)",
      "Bash(npm run build:mac:arm64:*)",
      "Bash(plutil:*)",
      "Bash(xattr:*)",
      "Bash(codesign:*)",
      "Bash(env)",
      "Bash(APPLE_ID=\"info@federicopasinetti.it\")",
      "Bash(APPLE_APP_SPECIFIC_PASSWORD=\"ewng-ijfy-xvne-cytg\")",
      "Bash(APPLE_TEAM_ID=\"MNP388VJLQ\")",
      "Bash(export APPLE_TEAM_ID=\"MNP388VJLQ\")",
      "Bash(xcrun notarytool history:*)",
      "Bash(xcrun stapler staple:*)",
      "Bash(spctl:*)",
      "Bash(dir)",
      "Bash(npm run build:win:x64:*)",
      "Bash(del /F /Q \"\\?\\C:\\Users\\Federico\\Documents\\Federico\\In Lavorazione - Siti Web\\racetagger-desktop-v2\\vendor\\raw-preview-extractor\\nul\")",
      "Bash(npm run clean:*)",
      "Bash(python -c \"import os; os.remove(r''vendor\\raw-preview-extractor\\nul'')\")",
      "Bash(npm run build:ts:*)",
      "Bash(npx supabase:*)",
      "Bash(git stash:*)",
      "Bash(npm start)",
      "WebSearch",
      "WebFetch(domain:deepwiki.com)",
      "Bash(npm install:*)",
      "Bash(source venv-ml/bin/activate:*)",
      "Bash(pip install:*)",
      "Bash(python scripts/05-convert-to-onnx.py:*)",
      "Bash(npx electron-rebuild:*)",
      "Bash(python scripts/06-convert-rfdetr-to-onnx.py:*)",
      "WebFetch(domain:github.com)",
      "Bash(git clone https://github.com/PierreMarieCurie/rf-detr-onnx.git rf-detr-onnx-converter)",
      "Bash(uv sync:*)",
      "Bash(python rf-detr-onnx-converter/export.py:*)",
      "Bash(python:*)",
      "Bash(PYTORCH_ENABLE_MPS_FALLBACK=1 python:*)",
      "Bash(pip show:*)",
      "Bash(shasum:*)",
      "Bash(python3:*)",
      "mcp__ide__getDiagnostics",
      "Bash(sort:*)",
      "Bash(git reset:*)",
      "Bash(open:*)",
      "Bash(git checkout:*)",
      "Bash(git pull:*)",
      "Bash(npx electron-builder:*)",
      "Bash(ffmpeg:*)",
      "Bash(source:*)",
      "Bash(lsof:*)",
      "Bash(do basename=\"$txt##*/\")",
      "Bash(imgname=\"$basename%.txt.jpg\")",
      "Bash(if [ -f \"frames/$imgname\" ])",
      "Bash(then cp \"frames/$imgname\" labeled/)",
      "Bash(roboflow import:*)",
      "Bash(roboflow login:*)",
      "Bash(ROBOFLOW_API_KEY=\"111577bf-d905-4cff-a598-91b17df2365a\" roboflow import:*)",
      "Bash(ROBOFLOW_API_KEY=\"rf_3yxxEEH82ZYpsvfHCa5bVZJCHKu1\" roboflow import:*)",
      "Bash(ROBOFLOW_API_KEY=\"TFPr3dOFx7zh8Xoszccz\" roboflow import:*)",
      "Bash(do [ ! -f \"$f%.jpg.txt\" ])",
      "Bash(pip3 show:*)",
      "Bash(pip3 install:*)",
      "WebFetch(domain:docs.cloud.google.com)",
      "Bash(wc:*)",
      "Bash(grep:*)",
      "Bash(SUPABASE_ACCESS_TOKEN=sbp_50babb1bc18dcc6e4fafef1f9f58ed794f8fbead npx supabase functions deploy:*)",
      "Bash(SUPABASE_ACCESS_TOKEN=sbp_v0_bb2bc3f03c37b1b3d7a5154995bceb172d2b8f1e npx supabase functions deploy:*)",
      "WebFetch(domain:www.npmjs.com)",
      "Bash(rm:*)",
      "Bash(brew list:*)",
      "Bash(/opt/homebrew/opt/python@3.11/bin/python3.11:*)",
      "Bash(timeout 30 npm start:*)",
      "Bash(gh auth status:*)",
      "Bash(SUPABASE_ACCESS_TOKEN=sbp_50babb1bc18dcc6e4fafef1f9f58ed794f8fbead npx supabase functions logs:*)",
      "Bash(npx electron .)",
      "Bash(git fetch:*)",
      "Bash(git merge:*)",
      "Bash(npm uninstall:*)",
      "Bash(git worktree remove:*)",
      "Bash(git branch:*)",
      "Bash(git for-each-ref:*)",
      "Bash(SUPABASE_ACCESS_TOKEN=sbp_50babb1bc18dcc6e4fafef1f9f58ed794f8fbead npx supabase functions list:*)",
      "Bash(SUPABASE_ACCESS_TOKEN=sbp_v0_bb2bc3f03c37b1b3d7a5154995bceb172d2b8f1e npx supabase functions list:*)",
      "WebFetch(domain:supabase.com)",
      "WebFetch(domain:justadudewhohacks.github.io)",
      "Bash(xargs cat:*)",
      "Bash(SUPABASE_ACCESS_TOKEN=sbp_50babb1bc18dcc6e4fafef1f9f58ed794f8fbead npx supabase db dump --db-url \"postgresql://postgres.jvaptfshgrplexoslwwh:RaceTagger2025!@aws-0-eu-central-1.pooler.supabase.com:6543/postgres\")",
      "Bash(__NEW_LINE__ echo \"\")",
      "Bash(PGPASSWORD='RaceTagger2025!' psql \"postgresql://postgres.jvaptfshgrplexoslwwh:RaceTagger2025!@aws-0-eu-central-1.pooler.supabase.com:6543/postgres\" -c \"SELECT cron.schedule\\(''cleanup-expired-reservations'', ''*/5 * * * *'', ''SELECT * FROM cleanup_expired_reservations\\(\\)''\\);\")",
      "Bash(gh repo view:*)",
      "Bash(chmod:*)",
      "Bash(sqlite3:*)",
      "Bash(cd:*)",
      "Bash(npm run rebuild:*)",
      "Bash(xcode-select:*)",
      "Bash(clang++ -v:*)",
      "Bash(npm run build:native:*)",
      "Bash(clang++ -std=c++14 -stdlib=libc++ -x c++ -E:*)",
      "Bash(SDKROOT=/Library/Developer/CommandLineTools/SDKs/MacOSX.sdk npm run build:native:*)",
      "Bash(psql \"postgresql://postgres.taompbzifylmdzgbbrpv:MxfC6o1PWKiXBtDT@aws-0-eu-central-1.pooler.supabase.com:6543/postgres\" -c \"SELECT version, checksum_sha256, onnx_storage_path FROM onnx_models WHERE category_id = \\(SELECT id FROM sport_categories WHERE code = ''IMSA_WeatherTech''\\) AND is_active = true;\")",
      "Bash(tail:*)",
      "Bash(npm test:*)",
      "Bash(gh issue view:*)",
      "Bash(gh issue list:*)",
      "Bash(gh pr list:*)",
      "Bash(gh issue close:*)",
      "Bash(gh issue comment 3 --body \"$\\(cat <<''EOF''\n## Investigazione completata - Root Cause identificata\n\n### Stato: Bug confermato, presente nel codice attuale\n\n### Root Cause\n\nTre problemi concatenati causano il bug:\n\n#### 1. Il path organizzato viene scartato\n**File:** `src/unified-image-processor.ts` \\(linee 4836-4838\\)\n\n`organizer.organizeImage\\(\\)` restituisce un `FolderOrganizationResult` con il campo `organizedPath`, ma il chiamante lo ignora:\n\n```typescript\nconst result = await organizer.organizeImage\\(...\\);\nif \\(!result.success\\) {\n  console.error\\(...\\);\n}\n// ❌ result.organizedPath mai catturato né salvato\n```\n\n#### 2. L''analisi viene loggata PRIMA dello spostamento\n**File:** `src/unified-image-processor.ts` \\(linea 3119\\)\n\nIl log JSONL salva `originalPath` prima che la folder organization avvenga. Dopo il move, il percorso nel log diventa stale.\n\n#### 3. `updateImageMetadataWithCorrection\\(\\)` non è implementata\n**File:** `src/main.ts` \\(linee 3338-3371\\)\n\nLa funzione è uno stub con un TODO. Riceve solo `fileName` \\(non il path completo\\), non cerca il file nel filesystem, e ritorna `success: true` senza fare nulla.\n\n### Flusso del bug\n\n```\nAnalisi → log con /photos/IMG.jpg → file SPOSTATO in /photos/51/IMG.jpg\n→ utente modifica risultati → sistema cerca /photos/IMG.jpg → FILE NON TROVATO\n→ metadata update fallisce silenziosamente\n```\n\n### Fix proposto\n\n1. **Catturare `result.organizedPath`** dopo `organizeImage\\(\\)` e aggiornare `imageFile.originalPath`\n2. **Aggiornare il log JSONL** con il nuovo path post-spostamento\n3. **Implementare `updateImageMetadataWithCorrection\\(\\)`** con ricerca file reale \\(il TODO a linea 3356\\)\n4. **Passare il path completo** dal log-visualizer.js nelle corrections \\(non solo il filename\\)\n\n### File coinvolti\n\n| File | Linee | Problema |\n|------|-------|----------|\n| `src/unified-image-processor.ts` | 3089-3120 | Log prima dello spostamento |\n| `src/unified-image-processor.ts` | 4836-4838 | Scarta il path risultante |\n| `src/main.ts` | 3338-3371 | Funzione stub non implementata |\n| `renderer/js/log-visualizer.js` | 2069, 2135, 2182, 2537 | Invia solo fileName |\n| `src/utils/folder-organizer.ts` | 266-277 | ✅ Ritorna correttamente il path |\n\n### Note\n\n- Il bug si manifesta SOLO con modalità \"sposta\" \\(move\\). Con \"copia\" \\(copy\\) il file originale resta al suo posto e il problema non si nota.\n- La issue #8 \\(Review prima dello spostamento\\) risolverebbe strutturalmente questo problema separando analisi da applicazione risultati.\nEOF\n\\)\")",
      "Bash(gh issue comment:*)",
      "Bash(gh issue create --title \"Bug: Sovrascrittura/rimozione metadati pre-esistenti su file RAW\" --body \"$\\(cat <<''EOF''\n## Description\n\nWhen writing metadata \\(keywords, special instructions, extended description\\) to RAW files, ExifTool''s `-overwrite_original` flag overwrites pre-existing metadata such as color labels, captions, and copyright information.\n\n## Expected Behavior\n\nFor RAW files \\(NEF, ARW, CR2, CR3, ORF, RAW, RW2, DNG\\), metadata should be written **only** to XMP sidecar files, never directly to the RAW file. This preserves all existing metadata in the original RAW file.\n\n## Current Behavior\n\n`metadata-writer.ts` treats RAW and JPEG files identically - all functions \\(`writeKeywordsToImage`, `writeSpecialInstructions`, `writeExtendedDescription`, `writeFullMetadata`\\) write directly to the file with ExifTool regardless of format.\n\n## Root Cause\n\nNo check on file extension in `metadata-writer.ts` to distinguish RAW from standard formats.\n\n## Proposed Fix\n\n- Add `isRawFile\\(filePath\\)` helper that checks extension against known RAW formats\n- In each writing function, if file is RAW, delegate to `xmp-manager.ts` \\(`createXmpSidecar`\\) instead of writing with ExifTool\n- Verify `xmp-manager.ts` preserves copyright, color label, and other IPTC fields\n\n## Source\n\nBeta tester feedback \\(Michele, call 17 Dec / 8 Jan\\)\n\n## Labels\n\nbug, metadata, priority-high\nEOF\n\\)\" --label \"bug\")",
      "Bash(gh issue create:*)"
    ],
    "deny": [],
    "ask": []
  },
  "enableAllProjectMcpServers": true,
  "enabledMcpjsonServers": [
    "supabase"
  ]
}
